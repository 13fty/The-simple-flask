# 系统测试指南

## 概述

`test_system.py` 是一个综合测试脚本，用于测试宿舍管理系统的核心功能，包括账号注册、打卡功能和宿舍分配逻辑。

## 快速开始

### 1. 运行测试

```bash
cd /Users/MyCode/My_bysj
python scripts/test_system.py
```

### 2. 查看测试结果

测试脚本会输出详细的测试结果，包括：
- 每个测试用例的执行状态（✅ 通过 / ❌ 失败）
- 测试总结（总测试数、通过数、失败数、通过率）
- 失败详情（如果有失败的测试）

## 测试内容详解

### 测试1: 用户注册功能

#### 1.1 正常注册
- **目的**: 验证用户和学生信息能够正常保存到数据库
- **测试步骤**:
  1. 创建新用户和学生记录
  2. 验证数据是否正确保存
- **预期结果**: 用户和学生信息成功保存

#### 1.2 重复用户名
- **目的**: 验证用户名唯一性约束
- **测试步骤**:
  1. 尝试使用已存在的用户名创建新用户
  2. 验证是否抛出唯一约束错误
- **预期结果**: 抛出数据库唯一约束错误

#### 1.3 重复学号
- **目的**: 验证学号唯一性约束
- **测试步骤**:
  1. 尝试使用已存在的学号创建新学生
  2. 验证是否抛出唯一约束错误
- **预期结果**: 抛出数据库唯一约束错误

### 测试2: 打卡功能

#### 2.1 首次打卡
- **目的**: 验证能够创建打卡记录
- **测试步骤**:
  1. 创建打卡记录
  2. 验证记录是否正确保存
- **预期结果**: 打卡记录成功创建

#### 2.2 重复打卡
- **目的**: 验证同一天不能重复打卡
- **测试步骤**:
  1. 尝试在同一天创建第二条打卡记录
  2. 验证是否抛出唯一约束错误
- **预期结果**: 抛出唯一约束错误

#### 2.3 不同日期打卡
- **目的**: 验证可以在不同日期打卡
- **测试步骤**:
  1. 在不同日期创建打卡记录
  2. 验证两条记录都能成功保存
- **预期结果**: 两条记录都成功保存

#### 2.4 查询打卡记录
- **目的**: 验证能够查询打卡记录
- **测试步骤**:
  1. 查询用户的所有打卡记录
  2. 验证返回的记录数量正确
- **预期结果**: 返回正确的记录数量

### 测试3: 宿舍分配逻辑

#### 3.1 性别匹配
- **目的**: 验证学生只能分配到对应性别的宿舍楼
- **测试步骤**:
  1. 创建男生学生
  2. 调用分配函数
  3. 验证分配的宿舍楼性别为"男"
- **预期结果**: 分配到男生宿舍楼

#### 3.2 宿舍人数偏好（4人间）
- **目的**: 验证能够根据偏好分配宿舍
- **测试步骤**:
  1. 创建偏好4人间的学生
  2. 调用分配函数，指定偏好为4人间
  3. 验证分配的宿舍容量为4人或6人（降级）
- **预期结果**: 优先分配到4人间，如果4人间满则分配到6人间

#### 3.3 专业匹配
- **目的**: 验证相同专业的学生优先分配到同一宿舍
- **测试步骤**:
  1. 创建一个已入住的学生（专业A）
  2. 创建新学生（相同专业A）
  3. 调用分配函数
  4. 验证是否优先分配到同一宿舍
- **预期结果**: 优先分配到同一宿舍（如果其他因素允许）

#### 3.4 生活习惯匹配
- **目的**: 验证生活习惯相似的学生优先匹配
- **测试步骤**:
  1. 创建有生活习惯信息的学生
  2. 调用分配函数
  3. 验证能够成功分配
- **预期结果**: 成功分配到宿舍

#### 3.5 无可用床位
- **目的**: 验证无床位时的处理
- **测试步骤**:
  1. 将所有床位标记为已占用
  2. 尝试分配宿舍
  3. 验证返回 None
- **预期结果**: 返回 None，表示无可用床位

#### 3.6 性别不匹配
- **目的**: 验证性别不匹配时的处理
- **测试步骤**:
  1. 创建女生学生
  2. 如果只有男生楼，验证无法分配
  3. 如果有女生楼，验证分配到女生楼
- **预期结果**: 根据实际情况返回正确结果

## 测试数据管理

### 自动清理

测试脚本会自动清理测试数据：
- 所有用户名以 `test_` 开头的用户
- 所有学号以特定前缀开头的临时学生（ST, MA, AT, EX, NE, LS, NB, FE）
- 所有相关的打卡记录
- 所有占用的床位会被释放

### 测试数据隔离

测试脚本使用独立的测试数据，不会影响生产数据：
- 使用随机生成的用户名和学号
- 测试完成后自动清理
- 使用独立的测试楼栋（"测试楼"）

## 故障排查

### 常见问题

1. **测试失败：数据库连接错误**
   - 检查数据库文件是否存在
   - 检查数据库文件权限
   - 确保数据库表结构正确

2. **测试失败：表不存在**
   - 运行数据库迁移脚本
   - 检查模型定义是否正确

3. **测试失败：唯一约束错误**
   - 清理之前的测试数据
   - 检查数据库中的重复数据

4. **测试失败：无可用床位**
   - 运行 `add_dormitories.py` 创建宿舍数据
   - 检查床位状态是否正确

### 调试技巧

1. **查看详细错误信息**
   - 测试脚本会输出详细的错误信息
   - 检查失败详情部分

2. **单独运行测试**
   - 可以修改脚本，只运行特定测试
   - 在测试函数中添加断点

3. **检查数据库状态**
   - 使用数据库工具查看数据
   - 检查测试数据是否正确创建和清理

## 最佳实践

1. **定期运行测试**
   - 在代码修改后运行测试
   - 在部署前运行完整测试

2. **保持测试数据独立**
   - 不要在生产数据库上运行测试
   - 使用测试数据库或备份数据库

3. **理解测试逻辑**
   - 阅读测试代码，理解测试目的
   - 根据实际需求调整测试用例

4. **记录测试结果**
   - 保存测试结果日志
   - 跟踪测试通过率趋势

## 扩展测试

如果需要添加新的测试用例：

1. 在相应的测试函数中添加新测试
2. 使用 `result.add_pass()` 或 `result.add_fail()` 记录结果
3. 确保测试数据能够正确清理
4. 更新本文档

## 联系支持

如果遇到问题或需要帮助，请：
1. 查看错误信息
2. 检查数据库状态
3. 查看相关文档
4. 联系开发团队

